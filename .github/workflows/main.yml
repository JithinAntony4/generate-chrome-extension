name: CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout source
    - uses: actions/checkout@v2
    - name: setup node environment
    - uses: actions/setup-node@v2.1.1
    - with:
        node-version: 12
    - name: install
      run: npm ci --ignore-scripts
    - name : build
      run: npm run build:production
    - name : unit test
      run: npm run test
    - name : prepare artifact
      if: startsWith(github.ref, 'refs/tags/v')
      run: rsync -av --progress . dist --exclude node_modules --exclude dist --exclude .github --exclude .git --exclude src
    - name : upload artiface
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v2
      with:
        name: lib
        path: lib
  npm :
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: setup node environment
        uses: actions/setup-node@v2.1.1
        with:
          node-version: 12
          registry-url: https://registry.npmjs.org/
      - name: download artifact
        uses: actions/download-artifact@v2
        with:
          name: lib
          path: lib
      - name : npm publish
        run: |
          cd lib
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
